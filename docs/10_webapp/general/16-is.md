# IS: 16. 불충분한 세션 관리

**분류**: Web Application(웹)

**중요도**: 상

---

!!! info "PHP"

§ move_uploaded_file의 경우, php.ini 파일 내 'upload_tmp_dir' 속성에 정의된 경로에 'php***.tmp' 형식의 임시 파일로 업로드되며, 유효하지 않은 파일의 경우 삭제 처리됨 § 화이트리스트 방식의 확장자 검증 및 MIME 타입 검증 로직을 구현하여 허용된 유형의 파일만 업로드 허용 } else { Response.Write("업로드할 파일을 선택하세요."); } } } ... 파일 업로드 보안 코드 예시 // 파일명 정규화 function normalize_filename($filename) { $filename = urldecode($filename); $filename = normalizer_normalize($filename, Normalizer::FORM_C); $filename = str_replace("\0", "", $filename); $filename = preg_replace('/[<>:"\/\\\\|?*]/', '', $filename); $filename = preg_replace('/^[\.\s]+|[\.\s]+$/u', '', $filename); return $filename; } // 이중 확장자 차단 function is_valid_extension($filename, $allowed_exts) { $safe = normalize_filename($filename); if (substr_count($safe, '.') !== 1) return false; $ext = strtolower(pathinfo($safe, PATHINFO_EXTENSION)); return in_array($ext, $allowed_exts, true); } // 확장자 검증 function save_upload($file, $uploadDir) { § $allowed_exts = ['jpg','jpeg','png','pdf','txt']; $allowed_mime = ['image/jpeg','image/png','application/pdf','text/plain']; if (!is_valid_extension($file['name'], $allowed_exts)) { throw new Exception("허용되지 않은 확장자"); } // MIME 시그니처 확인 $mime = mime_content_type($file['tmp_name']); if (!in_array($mime, $allowed_mime, true)) { throw new Exception("허용되지 않은 파일 유형"); } // 파일명 난수화 $ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION)); $newName = bin2hex(random_bytes(16)) . '.' . $ext; $dest = rtrim($uploadDir, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR . $newName; if (!move_uploaded_file($file['tmp_name'], $dest)) { throw new Exception("파일 저장 실패"); } return $newName; } FD

15. 파일 다운로드

## 개요

### 점검 내용

웹 사이트에서 허용된 경로 외 다른 경로의 파일 접근 및 다운로드 가능 여부 점검

### 점검 목적

허용된 경로 외 다른 경로의 비인가된 접근을 방지하여, 공격자가 임의의 경로에 존재하는 파일을 열람하거나 다운로드하는 것을 차단하기 위함

### 보안 위협

Ÿ 해당 취약점이 존재할 경우, 공격자는 파일 다운로드 시 애플리케이션의 파라미터 값을 조작하여 웹 사이트의 중요한 파일(DB 커넥션 파일, 애플리케이션 파일 등) 또는 웹 애플리케이션 서버 루트에 있는 중요한 설정 파일(/etc/passwd, /etc/shadow 등)을 다운로드할 수 있음 Ÿ CGI, JSP, PHP 등 파일 다운로드 기능을 제공하는 애플리케이션에서 입력 경로를 검증하지 않는 경우, 공격자는 임의의 문자(../.. 등)나 주요 파일명을 입력하여 웹 애플리케이션 서버의 홈 디렉터리를 벗어나 임의의 위치에 있는 파일을 열람하거나 다운로드할 수 있음

### 참고

!!! info "경로 추적"
    웹 서버와 웹 애플리케이션의 파일 또는 디렉터리에 대한 접근이 적절히 통제되지 않아,

중요한 파일과 데이터에 비인가된 접근을 허용하는 취약점

!!! info "소스코드 및 취약점 점검 필요"

## 점검 대상 및 판단 기준

### 대상

웹 애플리케이션 소스코드, 웹 애플리케이션 서버, 웹 방화벽

### 판단 기준

**✅ 양호**: 입력값이 검증되어 허용된 경로와 파일만 접근 가능하고, 경로 조작 및 임의 시스템 파일

다운로드가 불가능하며, 다운로드 디렉터리 외의 접근과 상위 디렉터리 접근이 차단된 경우

**❌ 취약**: 입력값이 검증없이 처리되어 임의의 경로로 접근이 가능하거나 비인가된 파일을 다운로드할 수

있는 경우

## 조치 방법

다운로드 시 허용된 경로 이외의 디렉터리와 파일에 접근할 수 없도록 구현하고, 서버 사이드에서 ../..와 같은 경로 이동 관련 문자열에 대해 입력값 검증을 수행하여 비인가된 접근을 차단함

### 조치 시 영향

일반적인 경우 영향 없음

## 점검 및 조치 사례

**점검 방법**

**Step 1) 웹 사이트 내 파일 다운로드 기능 식별 후 파일 다운로드 요청 및 응답 패킷 내 URL 파라미터, POST**

데이터, 쿠키 등을 통해 파일 이름 및 경로 노출 여부 확인(또는 웹 사이트 내 이미지 렌더링 시 이미지 파일의 경로를 참조하는 경우)

**[ 프록시 도구를 이용한 파일 다운로드 파라미터 확인 ]**

**Step 2) 파일 다운로드 시 요청 패킷 내 파일 경로를 상대 경로(../../ 또는 ..\..\)로 변조하여 요청할 경우**

정상적으로 해당 경로 내 파일 다운로드 여부 확인

**[ 프록시 도구를 이용한 경로 조작 및 임의 시스템 파일 다운로드 시도 ]**

**Step 3) "Step 2"에서 파일 다운로드가 불가능한 경우 변조한 파일 경로를 아래의 인코딩(또는 치환, 종단 문자**

추가)을 적용하여 우회 가능 여부 확인

**[ 입력값 인코딩을 통한 우회 공격 시도 ]**

!!! info "참고"
    운영체제별 중요 시스템 파일 예시

구분 파일 경로 설명 Linux /etc/passwd 시스템유저 계정 리스트 /etc/group 시스템그룹 정보 리스트 /etc/hosts 호스트명과 IP주소 매핑 정보 /var/log/message 시스템 메시지 로그 ~.bash_history 사용자 명령어 기록 /etc/service 활성화된 서비스 정보 Windows C:\Windows\System32\config\SAM 사용자 계정 및 암호의 해시 정보 C:\Windows\System32\config\SYSTEM 시스템 설정과 관련된 레지스트리 파일 C:\Windows\System32\config\AppEvent.evt 응용프로그램 이벤트 로그 C:\Windows\System32\config\SecEvent.evt 보안 이벤트 로그 C:\Windows\System32\drivers\etc\hosts 호스트명과 IP주소 매핑 정보

